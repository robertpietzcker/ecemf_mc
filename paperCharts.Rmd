---
title: "Paper charts"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
---

<style>
.main-container {
  max-width: 95% !important;
}
.toc-content {
  padding-left: 0px !important;
}
.svg-container {
  margin: auto !important;
}
</style>


<!-- Setting default chunk options -->
```{r chunkOptions, echo=FALSE, include = FALSE}
#knitr::opts_chunk$set(echo = TRUE)
# setting global R chunk options (https://yihui.name/knitr/options/#chunk_options)
  knitr::opts_chunk$set(dev='svglite', # svg, png,...
                        fig.ext = ".svg",
                        #fig.asp = .8 # default aspect ratio
                        fig.width = 12,
                        fig.height = 6,
                        dpi=100
                        )
```  


```{r loading_packages, echo=FALSE, include = FALSE}

  #Loading required packages
  packagesList <- c("reticulate", "tidyr", "dplyr", "quitte", "openxlsx", "piamInterfaces", "ggplot2", "grid", "gridExtra", "ggh4x")
  #packagesList <- c("quitte","ggplot2","geomtextpath","ggpattern","tidyr","grid","stringr", "grid", "gridExtra","ggrepel","kableExtra","dplyr","remind2","rsvg","ggsvg")
  packages <- suppressWarnings(suppressMessages(lapply(packagesList, function(x){ if(!require(x, character.only = T, quietly = T)){ install.packages(x); return(paste0("installed missing package: ", x)) } else paste0("required package is installed: ", x) } )))

  #use_python("C:/Users/robertp/AppData/Local/Programs/Python/Python313")
```


<!-- ## download and prepare data -->

```{r load_data, echo=FALSE, include = FALSE}

downloadData <- FALSE

# select data file
dataFolder <- sort(list.dirs(path = "./data", full.names = TRUE, recursive = FALSE), decreasing = T)[1]
time <- basename(dataFolder)
outFolder <- paste0("./output/", time)
dataRDSFile <- paste0("./data/", time, "/WP1_", time, ".rds")
if(!(downloadData) & (file.exists(dataRDSFile))){
  df <- readRDS(dataRDSFile)
  histRDS <- paste0("./data/", time, "/WP1_", time, "_hist.rds")
  histData <- readRDS(histRDS)
} else {
  source("./prepare_data.R")
  dataFolder <- sort(list.dirs(path = "./data", full.names = TRUE, recursive = FALSE), decreasing = T)[1]
  time <- basename(dataFolder)
  dataRDS <- paste0("./data/", time, "/WP1_", time, ".rds")
  saveRDS(df,dataRDSFile)
  histRDS <- paste0("./data/", time, "/WP1_", time, "_hist.rds")
  histData <- histOrigN
  saveRDS(histData, histRDS)
}

```


```{r create_charts, echo=FALSE, include=FALSE}

  # creating charts
  g <- NULL

  # output folder
  dir.create(paste0("./output/", time, "/svg"), recursive = TRUE, showWarnings = FALSE)
  dir.create(paste0("./output/", time, "/png"), recursive = TRUE, showWarnings = FALSE)

``` 


```{r aesthetics, echo=FALSE, include=FALSE}

color <- c(
  #model
  "Historical" = "black",
  "mean" = "#c0c0c0",
  "IMAGE" = "#00ffff",
  "Euro-Calliope" = "#84eab3",
  "MESSAGE" = "#800080",
  "PRIMES" = "#0000ff",
  "PROMETHEUS" = "#ffd900",
  "REMIND" = "#ff6347",
  "TIAM-ECN" = "#4682b4",
  "TIAM-ECN 1.2" = "#000000",
  "WITCH" = "#228b22",
  "LIMES" = "#ffaf47",
  "MEESA" = "#ff00ff",
  "OSeMBE" = "#a52a2a"
)

modelLinetype <- c(
  "Historical" = "solid",
  "mean" = "42", # dashed, 4 points on, one off
  "IMAGE" =       "solid" ,
  "Euro-Calliope" = "solid", 
  "MESSAGE" =    "solid",
  "PRIMES" =     "solid",
  "PROMETHEUS" = "solid",
  "REMIND" =     "solid",
  "TIAM-ECN" =   "solid",
  "TIAM-ECN 1.2" = "solid",
  "WITCH" =      "solid",
  "LIMES" =      "solid",
  "MEESA" =      "solid",
  "OSeMBE" =     "solid"
)

modelAlpha <- c(
  "Historical" =      1,
  "mean" =            1,
  "IMAGE" =         0.5,
  "Euro-Calliope" = 0.5,
  "MESSAGE" =       0.5,
  "PRIMES" =        0.5,
  "PROMETHEUS" =    0.5,
  "REMIND" =        0.5,
  "TIAM-ECN" =      0.5,
  "TIAM-ECN 1.2" =  0.5,
  "WITCH" =         0.5, 
  "LIMES" =         0.5,
  "MEESA" =         0.5,
  "OSeMBE" =        0.5
)

modelsOrder <- c(
  "Historical",
  "mean",
  "OSeMBE",
  "MEESA",
  "LIMES",
  "WITCH",
  "TIAM-ECN",
  "TIAM-ECN 1.2",
  "REMIND",
  "PROMETHEUS",
  "PRIMES",
  "MESSAGE",
  "IMAGE",
  "Euro-Calliope"
)


modelShape <- c(
  "Historical"    = NA, 
  "mean"          = NA, 
  "IMAGE"         = 21,
  "Euro-Calliope" = 21, 
  "MESSAGE"       = 21, 
  "PRIMES"        = 21, 
  "PROMETHEUS"    = 21, 
  "REMIND"        = 21, 
  "TIAM-ECN"      = 21, 
  "TIAM-ECN 1.2"  = 21, 
  "WITCH"         = 21,
  "LIMES"         = 23, 
  "MEESA"         = 23, 
  "OSeMBE"        = 23 
)

modelsFullSystem   <-  c("IMAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","TIAM-ECN 1.2","WITCH")

``` 


```{r paper_theme, echo=FALSE, include=FALSE}

theme_paper <- function(){
  theme_minimal(
    base_size = 24
    #, base_family = "Helvetica"
    ) +
    theme(
      # Panel background and grid
      panel.background = element_rect(fill = "white", colour = NA),
      panel.grid.major = element_line(colour = "grey90", size = .7),
      panel.grid.minor = element_line(colour = "grey95", size = .7),
      plot.background = element_rect(fill="#FFFFFF", color = NA),
      panel.grid.major.y = element_line(linetype = "dashed"),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      plot.margin = margin(r = 20, l = 20),
      
      # Axis lines, titles, and text
      #axis.line = element_line(colour = "black", size = 0.5),
      axis.ticks = element_line(colour = "black", size = 0.5),
      axis.title = element_text(size = 14, face = "plain", colour = "black"),
      axis.text = element_text(size = 12, colour = "black"),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      
      # Plot title and subtitle
      plot.title = element_text(size = 16, face = "plain", hjust = 0, margin = margin(t = 10, b = 10), colour = "black"),
      plot.subtitle = element_text(size = 12, face = "plain", hjust = 0, margin = margin(b = 10), colour = "grey50"),
      
      # Legend
      legend.position = "bottom",
      legend.box = "horizontal",
      legend.title = element_blank(),
      legend.text = element_text(size = 12, colour = "black"),
      #legend.key.size = unit(0.5, "lines"),
      legend.key.width = unit(2, 'cm'),
      
      # Strip for facets
      strip.background = element_rect(fill = "white", colour = NA),
      #strip.text = element_blank(),
      panel.spacing = unit(3, "lines")
    )
}

def <- list(
  grid = list(
    lineSize = .7,
    color = "grey90",
    linetype = "dashed"
  ),
  yAxis= list(
    linewidth = 2,
    alpha = 0.3
  ),
  hist = list(
    lineSize = 1.5,
    areaColor = "#eeeeee",
    alpha = 0.5
  ),
  model = list(
    lineSize = 1.5,
    pointSize = 1.5,
    pointStroke = 1.5,
    shape = 21
  ),
  decadeChange = list(
    lineSize = 0.5,
    wideLineSize = 0.5,
    wideAlpha = 0.3,
    pointSize = 1,
    pointStroke = 1
  )
)

#update_geom_defaults("segment", list(size = 0.7))
#update_geom_defaults("point"  , list(size = 2, stroke = 2))
#update_geom_defaults("label"  , list(hjust = 0.5))

dir.create(paste0(outFolder, "/paperCharts/png"), showWarnings = FALSE, recursive = TRUE)
dir.create(paste0(outFolder, "/paperCharts/svg"), showWarnings = FALSE, recursive = TRUE)


```


## Figure 1

<!-- ### Figure 1.a -->

<!-- Greenhouse gas emissions for scenarios reaching climate neutrality by 2050 -->

<!-- Decadal average of the annual percentage change in the mean model results, expressed relative to 1990 baseline values, shown in blue. -->

```{r figure_1, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable == "Emi|Kyoto Gases|synthetic",
         period >=2005, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsFullSystem, 
         model != "PRIMES" | period != 2005,
         model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
         model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
         region == "EU27 & UK (*)") %>%
  rbind(
    df %>%
      filter(variable == "Emissions|CO2|Energy and Industrial Processes",
             period >=2005, period <= 2050,
             model %in% modelsFullSystem,
             scenario %in% c("WP1 NetZero"),
             region == "EU27 & UK (*)")
  ) %>%
  rbind(
    histData %>%
      filter(variable == "Emi|GHG|w/ Bunkers",
             region == "EUR",
             model == "UNFCCC") %>%
      mutate(variable = "Emi|Kyoto Gases|synthetic",
             model = "Historical") %>%
      rbind(
        histData %>%
          filter(variable == "Emi|CO2|w/ Bunkers|Energy and Industrial Processes",
                 region == "EUR",
                 model == "UNFCCC") %>%
          mutate(variable = "Emissions|CO2|Energy and Industrial Processes",
                 model = "Historical")
      )
  )


plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / value[period == 1990])/10 * 100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period == 2050 ~ 1.5,
      TRUE ~ -0.5
    )
  )

limitY <- max(plotData$value)

g_data <- list(
  "Emi|Kyoto Gases|synthetic" = list(
    data = plotData %>% filter(variable == "Emi|Kyoto Gases|synthetic"),
    decade_change = decade_change %>% filter(variable == "Emi|Kyoto Gases|synthetic"),
    title = "GHG Emissions",
    subtitle = expression(paste("Mt ", CO[2]," eq/yr"))
  ),
  "Emissions|CO2|Energy and Industrial Processes" = list(
    data = plotData %>% filter(variable == "Emissions|CO2|Energy and Industrial Processes"),
    decade_change = decade_change %>% filter(variable == "Emissions|CO2|Energy and Industrial Processes"),
    title = expression(paste(CO[2],"  Emissions - energy and industrial processes")),
    subtitle = expression(paste("Mt ", CO[2]," /yr"))
  )
)

g <- list()
for( chart in names(g_data)){
  g[[chart]] <- ggplot(g_data[[chart]][["data"]],aes(x=period,y=value)) +
    geom_segment(data= g_data[[chart]][["data"]] %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
    annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
    annotate("text", x = 2005, y = 3000, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
    geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
    geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
    geom_point(data = g_data[[chart]][["data"]] %>% filter(!(model %in% c("Historical", "mean")), period > 2023), shape = def$model$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
    geom_line(data=g_data[[chart]][["decade_change"]], aes(y = value/5), size=def$decadeChange$wideLineSize, linetype="solid", color = "#90D5FF", alpha=def$decadeChange$wideAlpha) +
    geom_line(data=g_data[[chart]][["decade_change"]], aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
    geom_point(data=g_data[[chart]][["decade_change"]], aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
    geom_label(data = g_data[[chart]][["decade_change"]] %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
    theme_paper() +
    facet_wrap(~ variable) + 
    scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
    scale_alpha_manual(values = modelAlpha) +
    scale_linetype_manual(values = modelLinetype) +
    labs(title = g_data[[chart]][["title"]], subtitle = g_data[[chart]][["subtitle"]]) + 
    scale_x_continuous(expand = c(0, 0)) +
    expand_limits(y = limitY) +
    coord_cartesian(clip = 'off') +
    theme(strip.text = element_blank())
}

# function to extract the legend
g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

g[["legend"]] <- g_legend(g$`Emi|Kyoto Gases|synthetic` + theme(plot.margin = margin(t = 20)))

g[["Figure 1.a"]] <- gridExtra::arrangeGrob(
  g$`Emi|Kyoto Gases|synthetic` + theme(legend.position="none"),
  g$`Emissions|CO2|Energy and Industrial Processes` + theme(legend.position="none"),
  g[["legend"]],
  layout_matrix = rbind(c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(3, 3))
   )


# ggsave(paste0(outFolder, "/paperCharts/png/Figure 1.a Greenhouse gas emissions for scenarios reaching climate neutrality by 2050.png"), g[["Figure 1.a"]], device="png", width = 12, height = 6, dpi=300, units = "in")
# ggsave(paste0(outFolder, "/paperCharts/svg/Figure 1.a Greenhouse gas emissions for scenarios reaching climate neutrality by 2050.svg"), g[["Figure 1.a"]], device="svg", width = 12, height = 6, dpi=100, units = "in")

```


<!-- ```{r, echo=FALSE, fig.width=12, fig.height=6} -->

<!-- grid.newpage() -->
<!-- grid.draw(g[["Figure 1.a"]]) -->

<!-- ``` -->


<!-- --- -->

<!-- ## Figure 1.b -->

<!-- Electricity Supply CO2 emissions -->

<!-- Decadal average of the annual percentage change in the mean model results, expressed relative to 2000 baseline values, shown in blue. -->

```{r figure 1.b, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable == "Emissions|CO2|Energy|Supply|Electricity",
         period >=2005, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model != "PRIMES" | period != 2005,
         model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
         model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod",
           region == "EUR",
           model == "Ember") %>%
      mutate(variable = "Emissions|CO2|Energy|Supply|Electricity",
             model = "Historical")
    )

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / value[period == 2000])/10 * 100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period == 2050 ~ 1.5,
      TRUE ~ -0.5
    )
  )

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / value[period == 2000])/10 * 100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period == 2040 ~ 1.8,
      period == 2050 ~ -1,
      TRUE ~ -0.5
    )
  )

g[["Figure 1.b"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2010, y = 750, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(period > 2023), aes(colour = model, shape = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$wideLineSize, linetype="solid", color = "#90D5FF", alpha=def$decadeChange$wideAlpha) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
  geom_point(data=decade_change, aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() + 
  scale_color_manual(values = setNames(color[levels(plotData$model)], levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  scale_shape_manual(values = modelShape) +
  labs(title = expression(paste("Electricity Supply ", CO[2]," Emissions")), subtitle = expression(paste("Mt ", CO[2]," /yr"))) +
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') + 
  theme(legend.position = "right",
        legend.key.height = unit(1, 'cm'),
        plot.margin = margin(r = 100, l = 100),
        legend.margin = margin(l = 50),
        strip.text = element_blank()
  ) +
  guides(color=guide_legend(ncol=2))

# ggsave(paste0(outFolder, "/paperCharts/png/Figure 1.b Electricity Supply CO2 emissions.png"), g[["Figure 1.b"]], device="png", width = 12, height = 5, dpi=300, units = "in")
# ggsave(paste0(outFolder, "/paperCharts/svg/Figure 1.b Electricity Supply CO2 emissions.svg"), g[["Figure 1.b"]], device="svg", width = 12, height = 5, dpi=100, units = "in")


```


<!-- ```{r, echo=FALSE, fig.width=12, fig.height=5} -->

<!-- g[["Figure 1.b"]] -->

<!-- ``` -->

<!-- --- -->

<!-- ## Figure 1 -->

<!-- Electricity Supply CO2 emissions -->

```{r figure 1, echo=FALSE, include=FALSE}

g[["Figure 1"]] <- gridExtra::arrangeGrob(
  g$`Emi|Kyoto Gases|synthetic` + 
    theme(legend.position="none") + 
    labs(title = "1.a) GHG Emissions", subtitle = expression(paste("Mt ", CO[2]," eq/yr"))) +
    theme(plot.margin = margin(b = 10, r=20)),
  g$`Emissions|CO2|Energy and Industrial Processes` +
    theme(legend.position="none") +
    labs(title = expression(paste("1.b) ", CO[2], " Emissions - energy and industrial processes")), subtitle = expression(paste("Mt ", CO[2]," eq/yr"))) +
    theme(plot.margin = margin(b = 10, r=20)),
  g[["Figure 1.b"]] + 
    theme(plot.margin = margin(r = 60, t = 10), legend.margin = margin(l = 80)) + 
    labs(title = expression(paste("1.c) Electricity Supply ", CO[2]," Emissions")), subtitle = expression(paste("Mt ", CO[2]," eq/yr"))),
  layout_matrix = rbind(c(1, 2),
                        c(3, 3))
   )

ggsave(paste0(outFolder, "/paperCharts/png/Figure 1 Emissions panel.png"), g[["Figure 1"]], device="png", width = 12, height = 10, dpi=300, units = "in")
ggsave(paste0(outFolder, "/paperCharts/svg/Figure 1 Emissions panel.svg"), g[["Figure 1"]], device="svg", width = 12, height = 10, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=10}

grid.newpage()
grid.draw(g[["Figure 1"]])

```

Figure 1. Emissions panel (EU27 and UK). Historical UNFCCC (figure 1.a and 1.b) and Ember (Figure 1.c) data shown in black. Decadal average of the annual percentage change in the mean model results, expressed relative to 1990 (figure 1.a and 1.b) or 2000 (figure 1.c) baseline values, shown in blue.

---

## Figure 2

<!-- Electricity Generation from Wind and Solar and Share in electricity generation -->

```{r SE_Electricity_VRE, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable == "Secondary Energy|Electricity|WindSolar",
         period >=2005, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model != "PRIMES" | period != 2005,
         model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015)),
         model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "SE|Electricity|WindSolar",
           region == "EUR",
           model == "Ember") %>%
      mutate(variable = "Secondary Energy|Electricity|WindSolar",
             model = "Historical")
    ) %>%
  mutate(value = value*277.7777778) # EJ 2 TWh

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period == 2010 ~ 1.35,
      period == 2020 ~ 1.5,
      period == 2030 ~ 1.9,
      period == 2050 ~ 1.5,
      TRUE ~ 1.2
    )
  )

g[["Electricity Generation from Wind and Solar"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2012, y = 5000, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(period > 2023), aes(colour = model, shape = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=decade_change, aes(y = value/5), size=5, linetype="solid", color = "#90D5FF", alpha=0.3) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
  geom_point(data=decade_change, aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() +
  scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  scale_shape_manual(values = modelShape) +
  labs(title = "2.a) Electricity Generation from Wind and Solar", subtitle = "TWh/yr") + 
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  expand_limits(y = c(0,1))


plotDataRaw <- df %>%
  filter(variable == "Secondary Energy|Electricity|VRE Share",
         period >=2005, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model != "PRIMES" | period != 2005,
         model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
         model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "SE|Electricity|VRE Share",
           region == "EUR",
           model == "Ember") %>%
      mutate(variable = "Secondary Energy|Electricity|VRE Share",
             model = "Historical")
    )


plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period == 2010 ~ 1.35,
      period == 2020 ~ 1.7,
      period == 2030 ~ 1.4,
      TRUE ~ -0.5
    )
  )

g[["Share in electricity generation"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2012, y = 0.5, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(period > 2023), aes(colour = model, shape = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=decade_change, aes(y = value/5), size=5, linetype="solid", color = "#90D5FF", alpha=0.3) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
  geom_point(data=decade_change, aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() +
  scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  scale_shape_manual(values = modelShape) +
  labs(title = "2.b) Share in electricity generation", subtitle = "%") + 
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1), expand = c(0, 0)) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  expand_limits(y = c(0,1))

g[["legend"]] <- g_legend(g$`Electricity Generation from Wind and Solar` + guides(color = guide_legend(nrow = 2)) + theme(plot.margin = margin(t = 20)))


g[["Figure 2"]] <- gridExtra::arrangeGrob(
  g$`Electricity Generation from Wind and Solar` + theme(legend.position="none", plot.margin = margin(r=10, l=20)),
  g$`Share in electricity generation` + theme(legend.position="none", plot.margin = margin(r=20, l=10, b=15), 
                                              #plot.subtitle = element_text(margin = margin(b = 40))
                                              ),
  g[["legend"]],
  layout_matrix = rbind(c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(3, 3))
   )


ggsave(paste0(outFolder, "/paperCharts/png/Figure 2. Electricity Generation from Wind and Solar and Share in electricity generation.png"), g[["Figure 2"]], device="png", width = 12, height = 6, dpi=300, units = "in")
ggsave(paste0(outFolder, "/paperCharts/svg/Figure 2. Electricity Generation from Wind and Solar and Share in electricity generation.svg"), g[["Figure 2"]], device="svg", width = 12, height = 6, dpi=100, units = "in")


```


```{r, echo=FALSE, fig.width=12, fig.height=6}

grid.newpage()
grid.draw(g[["Figure 2"]])

```

Figure 2. Variable renewables generation and electricity share. Decadal average of the annual percentage change in the mean model results, expressed relative to the preceding decade, shown in blue.


---


## Figure 3

<!-- Share of electricity and hydrogen in final energy -->

```{r fe_electricity_share, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable == "Final Energy|Electricity Share woBunkers woNonEnergy",
         period >=2005, period <= 2050,
         model != "PRIMES" | period != 2005,
         model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
         model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
         model != "Euro-Calliope",
         model %in% modelsFullSystem,
         scenario %in% c("WP1 NetZero"),
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "Final Energy|Electricity Share woBunkers woNonEnergy",
           region == "EUR",
           period >=2000,
           model == "IEA") %>%
      mutate(variable = "Final Energy|Electricity Share woBunkers woNonEnergy",
             model = "Historical")
    )

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      TRUE ~ -0.5
    )
  )

 g[["Share of electricity in final energy use"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2012, y = 0.5, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(!(model %in% c("Historical", "mean")), period > 2023), shape = def$model$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=decade_change, aes(y = value/5), size=5, linetype="solid", color = "#90D5FF", alpha=0.3) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
  geom_point(data=decade_change, aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() +
  scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  labs(title = "3.a) Electricity share in final energy use", subtitle = "%") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), expand = c(0, 0)) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  expand_limits(y = c(0,1))

## Final Energy Electricity shares per sector

  vars <- list(
    "Buildings"=c("Final Energy|Residential and Commercial|Electricity Share"),
    "Industry"=c("Final Energy|Industry|Electricity Share"),
    "Transport"=c("Final Energy|Transportation|Electricity Share")
  )
  
  varTosector <- setNames(names(unlist(vars)),unlist(vars))

  plotDataRaw <- df %>%
    filter(variable %in% names(varTosector),
           period >=2005, period <= 2050,
           model != "PRIMES" | period != 2005,
           model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
           model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
           model != "Euro-Calliope",
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(sector = factor(varTosector[as.character(variable)], levels = rev(names(vars))))

  plotData <- plotDataRaw %>%
    rbind(
      plotDataRaw %>%
        filter(model != "Historical") %>%
        group_by(scenario, region, variable, unit, period, sector) %>%
        summarise(mean_value = mean(value, na.rm = TRUE)) %>%
        ungroup() %>%
        rename(value = mean_value) %>%
        mutate(model = "mean") %>%
        select(all_of(names(plotDataRaw)))
    ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))
  
  g[["Share of electricity in final energy use per sector"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
    annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
    geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
    geom_line(size=1,aes(color=model,linetype=model, alpha = model)) + # models data
    geom_point(data = plotData %>% filter(!(model %in% c("Historical", "mean")), period > 2023), shape = 21, aes(colour = model), fill = "white", size = 1, stroke = 1) +
    theme_paper() +
    facet_wrap(~sector) +
    scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
    scale_alpha_manual(values = modelAlpha) +
    scale_linetype_manual(values = modelLinetype) +
    #labs(title = "Share of electricity in final energy use", subtitle = "%") +
    scale_x_continuous(expand = c(0, 0), breaks = seq(2000, 2040, by = 20)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), expand = c(0, 0)) +
    expand_limits(x = 2000) +
    coord_cartesian(clip = 'off') +
  expand_limits(y = c(0,1))

```


```{r fe_hydrogen_share, echo=FALSE, include=FALSE}

df <- calc_addVariable(df, "`Final Energy|Hydrogen Share woBunkers woNonEnergy`" = "(`Final Energy|Hydrogen` - `Final Energy|Bunkers|Hydrogen` - `Final Energy|Non-Energy Use|Hydrogen`) / (`Final Energy` - `Final Energy|Bunkers` - `Final Energy|Non-Energy Use`)", units = "%", completeMissing = TRUE)



plotDataRaw <- df %>%
  filter(variable == "Final Energy|Hydrogen Share woBunkers woNonEnergy",
         period >=2005, period <= 2050,
         model != "PRIMES" | period != 2005,
         model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
         model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
         model != "Euro-Calliope",
         model %in% modelsFullSystem,
         scenario %in% c("WP1 NetZero"),
         region == "EU27 & UK (*)")

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      TRUE ~ 1.5
    )
  )

## witch has negative hydrogen values?????

g[["Share of hydrogen in final energy use"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2012, y = 0.5, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(!(model %in% c("Historical", "mean")), period > 2023), shape = def$model$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=decade_change, aes(y = value/5), size=5, linetype="solid", color = "#90D5FF", alpha=0.3) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
  geom_point(data=decade_change, aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() +
  scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  labs(title = "3.b) Hydrogen share in final energy use", subtitle = "%") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), expand = c(0, 0)) +
  expand_limits(x = 2000) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  expand_limits(y = c(0,1))

## Final Energy Hydrogen shares per sector

  vars <- list(
    "Industry"=c("Final Energy|Industry|Hydrogen Share"),
    "Buildings"=c("Final Energy|Residential and Commercial|Hydrogen Share"),
    "Transport"=c("Final Energy|Transportation|Hydrogen Share")
  )
  
  varTosector <- setNames(names(unlist(vars)),unlist(vars))

  plotDataRaw <- df %>%
    filter(variable %in% names(varTosector),
           period >=2005, period <= 2050,
           model != "PRIMES" | period != 2005,
           model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
           model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
           model != "Euro-Calliope",
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(sector = factor(varTosector[as.character(variable)], levels = rev(names(vars))))

  plotData <- plotDataRaw %>%
    rbind(
      plotDataRaw %>%
        filter(model != "Historical") %>%
        group_by(scenario, region, variable, unit, period, sector) %>%
        summarise(mean_value = mean(value, na.rm = TRUE)) %>%
        ungroup() %>%
        rename(value = mean_value) %>%
        mutate(model = "mean") %>%
        select(all_of(names(plotDataRaw)))
    ) %>%
    mutate(model = factor(model, levels=rev(modelsOrder)))
  
  g[["Share of hydrogen in final energy use per sector"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
    annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
    geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
    geom_line(size=1,aes(color=model,linetype=model, alpha = model)) + # models data
    geom_point(data = plotData %>% filter(!(model %in% c("Historical", "mean")), period > 2023), shape = 21, aes(colour = model), fill = "white", size = 1, stroke = 1) +
    theme_paper() +
    facet_wrap(~sector) +
    scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
    scale_alpha_manual(values = modelAlpha) +
    scale_linetype_manual(values = modelLinetype) +
    #labs(title = "Share of hydrogen in final energy use", subtitle = "%") +
    scale_x_continuous(expand = c(0, 0), breaks = seq(2000, 2040, by = 20)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), expand = c(0, 0)) +
    expand_limits(x = 2000) +
    coord_cartesian(clip = 'off') +
    expand_limits(y = c(0,1))

```


```{r fe_share, echo=FALSE, include=FALSE}

g[["legend"]] <- g_legend(g$`Share of electricity in final energy use` + guides(color = guide_legend(nrow = 2)) + theme(plot.margin = margin(t = 20)))

g[["Figure 3"]] <- gridExtra::arrangeGrob(
  g$`Share of electricity in final energy use` + theme(legend.position="none") + theme(plot.margin = margin(r=20, l=10,b = 10)),
  g$`Share of electricity in final energy use per sector` + theme(legend.position="none") + theme(plot.margin = margin(r=10, l=10, t = 10)),
  g$`Share of hydrogen in final energy use` + theme(legend.position="none") + theme(plot.margin = margin(r=20, l=10, b = 10)),
  g$`Share of hydrogen in final energy use per sector` + theme(legend.position="none") + theme(plot.margin = margin(r=20, l=10, t = 10)),
  g[["legend"]],
  layout_matrix = rbind(c(1, 3),
                        c(1, 3),
                        c(1, 3),
                        c(1, 3),
                        c(1, 3),
                        c(2, 4),
                        c(2, 4),
                        c(2, 4),
                        c(5, 5))
   )


ggsave(paste0(outFolder, "/paperCharts/png/Figure 3. Share of electricity and hydrogen in final energy.png"), g[["Figure 3"]], device="png", width = 12, height = 8, dpi=300, units = "in")
ggsave(paste0(outFolder, "/paperCharts/svg/Figure 3. Share of electricity and hydrogen in final energy.svg"), g[["Figure 3"]], device="svg", width = 12, height = 8, dpi=100, units = "in")


```


```{r, echo=FALSE, fig.width=12, fig.height=8}

grid.newpage()
grid.draw(g[["Figure 3"]])

```


Figure 3. Electricity and hydrogen final energy shares. Decadal average of the annual percentage change in the mean model results, expressed relative to the preceding decade, shown in blue.


---


## Figure 4

<!-- Left: Carbon-containing final energy. Right: Energy imports  -->


```{r Carbon-containing final energy, echo=FALSE, include=FALSE}

  vars <- list(
    "Fossils"  = c("Final Energy|Gases|Fossil",      "Final Energy|Liquids|Fossil",  "Final Energy|Solids|Fossil"),
    "Synfuels" = c("Final Energy|Gases|Electricity", "Final Energy|Liquids|Electricity"),
    "Biomass"  = c("Final Energy|Gases|Biomass",     "Final Energy|Liquids|Biomass", "Final Energy|Solids|Biomass")
  )

  carrier_color <- c(  
    "Fossils"  = "#727272",
    "Synfuels" = "#5ed5f0",
    "Biomass"  = "#005900"
  )
  
  varToCarrier <- setNames(gsub("\\d+$", "", names(unlist(vars))),unlist(vars))

  plotData <- df %>%
    filter(variable %in% names(varToCarrier),
           period %in% c(2020,2030,2040,2050),
           model != "PRIMES" | period != 2005,
           model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
           model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
           model != "Euro-Calliope",
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(model = factor(model, levels=rev(modelsOrder)),
           carrier = factor(varToCarrier[as.character(variable)], levels = rev(names(vars)))) %>%
    group_by(model,scenario,region,carrier,period) %>%
    summarise(value = sum(value))
     
  minfe <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% min()
  maxfe <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% max()
  
  plotDataTotal <- df %>%
    filter(variable == "FE|SolLiqGas",
           period %in% c(2020,2030,2040,2050),
           model != "PRIMES" | period != 2005,
           model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
           model != "Euro-Calliope",
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(model = factor(model, levels=rev(modelsOrder)))
    
  g[["Carbon-containing final energy"]] <- ggplot(plotData) +
    #geom_rect(data = data.frame(period = 2020), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "#eeeeee", alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8, aes(x=model, y=value, fill=carrier)) +
    geom_point(data = plotDataTotal, aes(x=model, y = value), colour = "black", size = 3, shape = 18) +
    facet_wrap(~period,nrow=1) +
    theme_paper() +
    scale_fill_manual(values = carrier_color) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = "4.a) Carbon-containing final energy", subtitle = "EJ/yr") +
    theme(legend.key.width = unit(0.7, 'cm'))
    
```

```{r Energy imports, echo=FALSE, include=FALSE}

  vars <- list(
    "Fossils"     = c("Trade|Secondary Energy|Liquids|Coal|Volume", "Trade|Primary Energy|Coal|Volume", "Trade|Primary Energy|Gas|Volume", "Trade|Secondary Energy|Liquids|Oil|Volume", "Trade|Primary Energy|Oil|Volume"),
    "Synfuels"    = c("Trade|Secondary Energy|Liquids|Electricity|Volume", "Trade|Secondary Energy|Liquids|Hydrogen|Volume"),
    "Hydrogen"    = c("Trade|Secondary Energy|Hydrogen|Volume"),
    "Biomass"     = c("Trade|Secondary Energy|Solids|Biomass|Volume", "Trade|Secondary Energy|Liquids|Biomass|Volume", "Trade|Primary Energy|Biomass|Volume"),
    "Electricity" = c("Trade|Secondary Energy|Electricity|Volume")
  )

  carrier_color <- c(  
    "Fossils"     = "#727272",
    "Synfuels"    = "#5ed5f0",
    "Hydrogen"    = "#00ffe4",
    "Biomass"     = "#005900",
    "Electricity" = "#fff300"
  )
  
  varToCarrier <- setNames(gsub("\\d+$", "", names(unlist(vars))),unlist(vars))

  histVars <- list(
    "Fossils" = c("Trade|Coal", "Trade|Oil", "Trade|Gas")
  )
  
  histVarToCarrier <- setNames(gsub("\\d+$", "", names(unlist(histVars))),unlist(histVars))
   
  plotData <- df %>%
    filter(variable %in% names(varToCarrier),
           period %in% c(2020,2030,2040,2050),
           model != "PRIMES" | period != 2005,
           model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
           model != "Euro-Calliope",
           model != "MEESA",
           model != "OSeMBE",
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(carrier = factor(varToCarrier[as.character(variable)], levels = rev(names(vars)))) %>%
    rbind(
      histData  %>%
        filter(variable %in% names(histVarToCarrier),
               region == "EUR",
               period %in% c(2020,2030,2040,2050),
               model == "IEA") %>%
          mutate(carrier = factor(histVarToCarrier[as.character(variable)], levels = rev(names(vars))),
                 model = "Historical")
      ) %>%
    group_by(model,scenario,region,carrier,period) %>%
    summarise(value = sum(value)) %>%
    mutate(model = factor(model, levels=rev(c(modelsOrder[modelsOrder != "Historical"], "Historical"))),
           value = value * - 1)
  
  minMport <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% min()
  maxMport <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% max()
  
  limitY <- c(min(minfe, minMport), max(maxfe,maxMport))
  
  g[["Energy imports"]] <- ggplot(plotData) +
    #geom_rect(data = data.frame(period = 2020), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "#eeeeee", alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8,aes(x=model,y=value,fill=carrier)) +
    facet_wrap(~period,nrow=1, scales = "free_x") +
    theme_paper() +
    scale_fill_manual(values = carrier_color) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = "4.b) Energy imports", subtitle = "EJ") +
    theme(legend.key.width = unit(0.7, 'cm')) +
    force_panelsizes(cols = plotData %>% select(model, period) %>% group_by(period) %>% summarize(unique_count = n_distinct(model)) %>% pull(unique_count))
	
    
```


```{r Carbon-containing final energy and energy imports, echo=FALSE, include=FALSE}

g[["legend"]] <- g_legend(g$`Energy imports` + guides(color = guide_legend(nrow = 1)) + theme(plot.margin = margin(t = 20)))

g[["Figure 4"]] <- gridExtra::arrangeGrob(
  g$`Carbon-containing final energy` + 
    theme(legend.position="none",
          axis.text.x = element_text(size = 8, colour = "black"),
          plot.margin = margin(r=20, l=20)) +
    expand_limits(y = limitY),
  g$`Energy imports` + theme(legend.position="none") + 
    theme(plot.margin = margin(r=20, l=20),
          axis.text.x = element_text(size = 8, colour = "black")) +
    expand_limits(y = limitY),
  g[["legend"]],
  layout_matrix = rbind(c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(3, 3))
   )


ggsave(paste0(outFolder, "/paperCharts/png/Figure 4. Carbon-containing final energy and energy imports.png"), g[["Figure 4"]], device="png", width = 12, height = 6, dpi=300, units = "in")
ggsave(paste0(outFolder, "/paperCharts/svg/Figure 4. Carbon-containing final energy and energy imports.svg"), g[["Figure 4"]], device="svg", width = 12, height = 6, dpi=100, units = "in")


```


```{r, echo=FALSE, fig.width=12, fig.height=6}

grid.newpage()
grid.draw(g[["Figure 4"]])

```


Figure 4. Residual carbon and energy imports.


---


## Figure 5

<!-- Emissions per sector -->


```{r Emissions per sector, echo=FALSE, include=FALSE}

  vars <- c(
    "non-CO2"                                       = "Emissions|Kyoto Gases|non-CO2 synthetic",
    "other CO2"                                     = "Emissions|CO2|Other",
    "Industrial Processes"                          = "Gross Emissions|CO2|Industrial Processes",
    "Demand - Industry (gross)"                     = "Gross Emissions|CO2|Energy|Demand|Industry",
    #"Demand - Other Sector"                         = "Emissions|CO2|Energy|Demand|Other",
    "Demand - AFOFI"                                = "Emissions|CO2|Energy|Demand|AFOFI",
    "Demand - Buildings"                            = "Emissions|CO2|Energy|Demand|Residential and Commercial",
    "Demand - Bunkers"                              = "Emissions|CO2|Energy|Demand|Bunkers",
    "Demand - Transport"                            = "Emissions|CO2|Energy|Demand|Transportation",
    "Energy Supply - Other (gross)"                 = "Gross Emissions|CO2|Energy|Supply|Other",
    "Energy Supply - H2 (gross)"                    = "Gross Emissions|CO2|Energy|Supply|H2",
    "Energy Supply - Solids (gross)"                = "Gross Emissions|CO2|Energy|Supply|Solids",
    "Energy Supply - Liquids (gross)"               = "Gross Emissions|CO2|Energy|Supply|Liquids",
    "Energy Supply - Gases (gross)"                 = "Gross Emissions|CO2|Energy|Supply|Gases",
    "Energy Supply - Heat (gross)"                  = "Gross Emissions|CO2|Energy|Supply|Heat",
    "Energy Supply - Electricity (gross)"           = "Gross Emissions|CO2|Energy|Supply|Electricity",
    "AFOLU"                                         = "Emissions|CO2|AFOLU synthetic",
    "Geological Carbon Removal"                     = "Carbon Removal|Geological Storage"#,
    # "Other Removal"                                 = "Emissions|CO2|Other Removal"
    )

  totalVars <- c(
    "Total Kyoto Gases"                             = "Emi|Kyoto Gases|synthetic",
    "Total CO2"                                     = "Emissions|CO2",
    "Total Energy and Industrial Processes (gross)" = "Gross Emissions|CO2|Energy and Industrial Processes"
    #"Total Energy and Industrial Processes"         = "Emissions|CO2|Energy and Industrial Processes",
    )
  
  varToSector <- setNames(c(names(vars),rev(names(totalVars))), c(vars,rev(totalVars)))

  histVars <- c(
    "non-CO2"                             = c("Emi|Kyoto Gases|non-CO2 calc"),
    "Demand - Industry (gross)"           = c("Emi|CO2|Energy|Demand|Industry"),
    "Demand - Buildings"                  = c("Emi|CO2|Energy|Demand|Buildings"),
    "Industrial Processes"                = c("Emi|CO2|Industrial Processes"),
    "Demand - Bunkers"                    = c("Emi|CO2|Energy|Demand|Transport|International Bunkers"),
    "Demand - Transport"                  = c("Emi|CO2|Energy|Demand|Transport"),
    "Energy Supply - Other (gross)"      = c("Emi|CO2|Calc Other"),
    "Energy Supply - Solids (gross)"      = c("Emi|CO2|Energy|Supply|Solids w/ couple prod"),
    "Energy Supply - Liquids (gross)"     = c("Emi|CO2|Energy|Supply|Liquids w/ couple prod"),
    "Energy Supply - Electricity (gross)" = c("Emi|CO2|Energy|Supply|Electricity and Heat"),
    "AFOLU"                               = c("Emi|GHG|Land-Use Change")
    )
  
  totalHistVars <- c(
    "Total Energy and Industrial Processes (gross)" = "Emi|CO2|w/ Bunkers|Energy and Industrial Processes",
    "Total Kyoto Gases"                             = "Emi|GHG|w/ Bunkers"
    )
  
  histVarToSector <- setNames(c(names(histVars),names(totalHistVars)),c(histVars,totalHistVars))

  sector_color <- c(  
    "non-CO2"                                       = "purple",
    "other CO2"                                     = "black",
    "Industrial Processes"                          = "#735550",
    "Demand - Industry (gross)"                     = "#ba6759",
    #"Demand - Other Sector"                         = "#5ed5f0",
    "Demand - AFOFI"                                = "#6df25e",
    "Demand - Buildings"                            = "#eba357",
    "Demand - Bunkers"                              = "#283280",
    "Demand - Transport"                            = "#a7c8db",
    "Energy Supply - Other (gross)"                 = "#ff33ff",
    "Energy Supply - H2 (gross)"                    = "#35effc",
    "Energy Supply - Solids (gross)"                = "#0c0c0c",
    "Energy Supply - Liquids (gross)"               = "#813499",
    "Energy Supply - Gases (gross)"                 = "#337fff",
    "Energy Supply - Heat (gross)"                  = "#b30000",
    "Energy Supply - Electricity (gross)"           = "#fcec35",
    "AFOLU"                                         = "darkgreen",
    "Geological Carbon Removal"                     = "red"
    )
  
  totalShape <- c(
    "Total Kyoto Gases"                             = 17,
    "Total CO2"                                     = 3,
    "Total Energy and Industrial Processes (gross)" = 18
    #"Total Energy and Industrial Processes"         = ,
    )
  
  plotData <- df %>%
    filter(variable %in% c(vars, totalVars, "Carbon Removal|Geological Storage|BioWITCH"),
           period %in% c(2020,2030,2040,2050),
           !(model %in% c("Euro-Calliope", "LIMES", "MEESA", "OSeMBE")),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = ifelse(as.character(variable) == "Carbon Removal|Geological Storage|BioWITCH", -value, value),
           variable = ifelse(as.character(variable) == "Carbon Removal|Geological Storage|BioWITCH", "Carbon Removal|Geological Storage", as.character(variable))) %>%
    group_by(model, scenario, region, variable, unit, period) %>%
    summarise(value = sum(value)) %>%
    ungroup() %>%
    mutate(sector = varToSector[as.character(variable)]) %>%
    rbind(
      histData  %>%
        filter(variable %in% c(histVars, totalHistVars),
               region == "EUR",
               period == 2020,
               model == "UNFCCC") %>%
          mutate(sector = histVarToSector[as.character(variable)],
                 model = "Historical")
      ) %>%
    rbind(
      histData  %>%
        filter(variable %in% c(histVars, totalHistVars),
               region == "EUR",
               period %in% c(2018:2022),
               model == "UNFCCC") %>%
        group_by(model, scenario, region, variable, unit) %>%
        summarize(value = mean(value, na.rm = TRUE)) %>%
        ungroup() %>%
        mutate(sector = histVarToSector[as.character(variable)],
               model = "Historical (5yr mean)",
               period = "2020") %>%
        select(all_of(names(df)), sector)
      ) %>%
    mutate(model = factor(model, levels=rev(c(modelsOrder[modelsOrder != "Historical"], "Historical (5yr mean)", "Historical"))),
           value = ifelse(variable == "Carbon Removal|Geological Storage", -value, value),
           sector = factor(sector, levels = c(names(vars), names(totalVars))))
    

	g[["Emissions per sector"]] <- ggplot(plotData %>% filter(variable %in% c(vars, histVars))) +
    #geom_rect(data = data.frame(period = 2020), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "#eeeeee", alpha = 0.5) +
    geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
	  geom_bar(stat='identity', alpha = 0.8,aes(x=model,y=value,fill=sector)) +
    geom_point(data = plotData %>% filter(variable %in% c(totalVars, totalHistVars)), aes(x=model, y = value, shape = sector), colour = "black", size = 3) + 
    facet_wrap(~period, nrow=1, scales = "free_x") +
    theme_paper() +
    scale_fill_manual(values = sector_color, breaks = rev(c("AFOLU", "Geological Carbon Removal", rev(names(sector_color)[!(names(sector_color) %in% c("AFOLU","Geological Carbon Removal"))])))) +
    scale_shape_manual(values = totalShape, breaks = ) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = "5) Emissions per sector", subtitle = expression(paste("Mt ", CO[2]," /yr"))) +
    theme(legend.key.width = unit(0.7, 'cm'),
          legend.position = "right",
          legend.box = "vertical") + 
    guides(fill = guide_legend(order = 2), 
           shape = guide_legend(order = 1)) + 
    force_panelsizes(cols = plotData %>% select(model, period) %>% group_by(period) %>% summarize(unique_count = n_distinct(model)) %>% pull(unique_count))
  

ggsave(paste0(outFolder, "/paperCharts/png/Figure 5. Emissions per sector.png"), g[["Emissions per sector"]], device="png", width = 12, height = 8, dpi=300, units = "in")
ggsave(paste0(outFolder, "/paperCharts/svg/Figure 5. Emissions per sector.svg"), g[["Emissions per sector"]], device="svg", width = 12, height = 8, dpi=100, units = "in")


```


```{r, echo=FALSE, fig.width=12, fig.height=8}

g[["Emissions per sector"]]

```

Figure 5. Emissions per sector.

---

## Figure 6

<!-- Carbon capture scale-up -->


```{r Carbon capture scale-up, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable %in% c("Carbon Capture"),
         period >=2005, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsFullSystem,
         region == "EU27 & UK (*)")

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period == 2050 ~ 1.4,
      TRUE ~ 1.7
    )
  )

g[["Carbon Capture"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2014.5, y = 500, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(!(model %in% c("Historical", "mean")), period > 2023), shape = def$model$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=decade_change, aes(y = value/5), size=5, linetype="solid", color = "#90D5FF", alpha=0.3) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
  geom_point(data=decade_change, aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() +
  scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  labs(title = "6.a) Carbon Capture", subtitle = expression(paste("Mt ", CO[2]," /yr"))) + 
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  coord_cartesian(clip = 'off')

  vars <- c(
    "Other"              = "Carbon Capture|Other",
    "Direct Air Capture" = "Carbon Capture|Direct Air Capture", 
    "Biomass"            = "Carbon Capture|Biomass",
    "Industrial Process" = "Carbon Capture|Industrial Processes",
    "Fossil"             = "Carbon Capture|Fossil"
    )
  
  carrier_color <- c(  
    "Other"              = "#bbbbbb",
    "Direct Air Capture" = "#5ed5f0",
    "Biomass"            = "#005900",
    "Industrial Process" = "#bf960d",
    "Fossil"             = "#0c0c0c")

  varToCarrier <- setNames(gsub("\\d+$", "", names(unlist(vars))),unlist(vars))

  plotData <- df %>%
    filter(variable %in% names(varToCarrier),
           period %in% c(2030,2040,2050),
           model %in% c("IMAGE","LIMES", "MEESA","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(model = factor(model, levels=rev(modelsOrder)),
           carrier = factor(varToCarrier[as.character(variable)], levels = names(vars))) %>%
    group_by(model,scenario,region,carrier,period) %>%
    summarise(value = sum(value))

  plotDataTotal <- df %>%
    filter(variable == "Carbon Capture",
           period %in% c(2030,2040,2050),
           model %in% c("IMAGE","LIMES", "MEESA","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(model = factor(model, levels=rev(modelsOrder)))
    
  g[["Carbon Capture by origin"]] <- ggplot(plotData) +
    #geom_rect(data = data.frame(period = 2020), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "#eeeeee", alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8, aes(x=model, y=value, fill=carrier)) +
    geom_point(data = plotDataTotal, aes(x=model, y = value), colour = "black", size = 3, shape = 18) +
    facet_wrap(~period,nrow=1) +
    theme_paper() +
    scale_fill_manual(values = carrier_color) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = "6.b) Carbon Capture by origin", subtitle = expression(paste("Mt ", CO[2]," /yr"))) +
    theme(legend.key.width = unit(0.7, 'cm')) +
    coord_cartesian(clip = 'off')

g[["Figure 6"]] <- gridExtra::arrangeGrob(
  g$`Carbon Capture` + 
    theme(plot.margin = margin(r = 20, l = 20),  
          plot.subtitle = element_text(margin = margin(b = 45)), 
          legend.margin = margin(t = 5, b = 20), 
          legend.text = element_text(size = 10, colour = "black")) +
  guides(color = guide_legend(nrow = 3)),
  g$`Carbon Capture by origin` + theme(plot.margin = margin(r = 20, l = 20, b = 10), legend.margin = margin(t = -10) ) + guides(fill = guide_legend(nrow = 2)),
  layout_matrix = rbind(c(1, 2))
   )

ggsave(paste0(outFolder, "/paperCharts/png/Figure 6. Carbon capture scale-up.png"), g[["Figure 6"]], device="png", width = 12, height = 6, dpi=300, units = "in")
ggsave(paste0(outFolder, "/paperCharts/svg/Figure 6. Carbon capture scale-up.svg"), g[["Figure 6"]], device="svg", width = 12, height = 6, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=6}

grid.newpage()
grid.draw(g[["Figure 6"]])

```


Figure 6. Carbon capture. Decadal average of the annual percentage change in the mean model results, expressed relative to the preceding decade, shown in blue.

---

## Figure 7

<!-- Carbon Price -->

```{r Carbon Price, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
    filter(variable == "Price|Carbon",
           period >=2015, period <= 2050,
           model != "PRIMES" | period != 2005,
           model != "TIAM-ECN" | ! (period %in% c(2005,2010,2015) ),
           model != "TIAM-ECN 1.2" | ! (period %in% c(2005,2010,2015) ),
           model %in% c("IMAGE","LIMES", "MEESA","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","TIAM-ECN 1.2","WITCH"),,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(mean_value = mean(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = mean_value) %>%
      mutate(model = "mean") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "mean", period %% 10 == 0, period > 2020) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10 * 100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      TRUE ~ -0.5
    )
  )


g[["Carbon Price"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2019.5, y = 600, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(!(model %in% c("Historical", "mean")), period > 2023), shape = def$model$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$wideLineSize, linetype="solid", color = "#90D5FF", alpha=def$decadeChange$wideAlpha) +
  geom_line(data=decade_change, aes(y = value/5), size=def$decadeChange$lineSize, linetype="solid", color = "#57B9FF") +
  geom_point(data=decade_change, aes(y = value/5), shape = 21, fill = "white", size = def$decadeChange$pointSize, stroke = def$decadeChange$pointStroke, color = "black") +
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y/5, label = paste0(round(change_percentage, 1), "% yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() +
  scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  labs(title = expression(paste("7) Carbon Price")), subtitle = expression(paste("/t", CO[2]))) + 
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') + 
  theme(legend.position = "right",
        legend.key.height = unit(1, 'cm'),
        plot.margin = margin(r = 100, l = 100),
        legend.margin = margin(l = 50),
        strip.text = element_blank()
  )

ggsave(paste0(outFolder, "/paperCharts/png/Figure 7. Carbon Price.png"), g[["Carbon Price"]], device="png", width = 12, height = 5, dpi=300, units = "in")
ggsave(paste0(outFolder, "/paperCharts/svg/Figure 7. Carbon Price.svg"), g[["Carbon Price"]], device="svg", width = 12, height = 5, dpi=100, units = "in")


```


```{r, echo=FALSE, fig.width=12, fig.height=5}

g[["Carbon Price"]]

```

Figure 7. Carbon price. Decadal average of the annual percentage change in the mean model results, expressed relative to the preceding decade, shown in blue.



